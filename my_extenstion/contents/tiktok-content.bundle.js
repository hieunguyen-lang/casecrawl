(()=>{"use strict";const e={API_KEY:{key:"api_key",defaultValue:""},POWER_ON:{key:"power_on",defaultValue:!0},TIKTOK:{key:"tiktok",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},FUNCAPTCHA:{key:"funcaptcha",defaultValue:{delayClick:100,loop:!0,isActive:!0,maxImageCaptcha:1e4}},ZALO:{key:"zalo",defaultValue:{delayClick:100,loop:!0,isActive:!0}},SHOPEE:{key:"shopee",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},RECAPTCHAV2:{key:"reCaptchav2",defaultValue:{delayClick:500,loop:!0,isActive:!0,useToken:!1}},AMZN:{key:"amzn",defaultValue:{delayClick:100,loop:!0,isActive:!0}},GEETEST:{key:"geetest",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},GARENA:{key:"garena",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}}};async function t(e,t,a){const o="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{return await new Promise(((c,n)=>{o.sendMessage({source:e,type:t,data:a},(e=>{o.lastError?n(new Error(`Error sending message: ${o.lastError.message}`)):c(e)}))}))}catch(e){throw console.error(`[messageHelpers] Error in sending message: ${e.message}`),e}}const a=async(e,t)=>{const a="undefined"!=typeof browser?browser.storage.local:chrome.storage.local,o="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{const c=await a.get([e]);if(o.lastError)throw new Error(`Error retrieving ${e}: ${o.lastError.message}`);return null!=c[e]?c[e]:t}catch(t){throw console.error(`[storageHelpers] Error retrieving ${e}:`,t),t}};Promise.resolve();async function o(e){return new Promise((t=>setTimeout(t,e)))}async function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{timeout:5e3,maxRetries:3};try{const{timeout:a,maxRetries:c}=t,n={arkoselabs:"image/jpeg"};function i(e){for(const[t,a]of Object.entries(n))if(e.includes(t))return a;return"image/png"}if(e instanceof HTMLCanvasElement||e.tagName&&"CANVAS"===e.tagName.toUpperCase())try{if(0===e.width||0===e.height)return console.log("Canvas rỗng hoặc không có kích thước"),"";const r=e.getBoundingClientRect(),l=r.width,s=r.height,u=document.createElement("canvas");u.width=l,u.height=s;u.getContext("2d").drawImage(e,0,0,l,s);const h="image/png",f=u.toDataURL(h).split(",")[1];return f||(console.log("Không thể lấy base64 từ canvas"),"")}catch(g){return console.log("Lỗi khi chụp màn hình canvas:",g),""}if(e instanceof Element)try{const d=e.src;if(d&&d.startsWith("data:image/")){const m=d.split(",")[1];return m||(console.log("Base64 rỗng từ src của element"),"")}e=d||""}catch(p){return console.log("Lỗi khi xử lý element:",p),""}if("string"==typeof e&&e.startsWith("blob:")){console.log("Da vao blob");try{return await new Promise((t=>{const a=new Image;a.setAttribute("crossOrigin","anonymous");const o=setTimeout((()=>{t("")}),1e3);a.onload=function(){console.log("Vao trong onload"),clearTimeout(o);try{const a=document.createElement("canvas");a.width=this.naturalWidth,a.height=this.naturalHeight;a.getContext("2d").drawImage(this,0,0);const o=i(e);a.toBlob((e=>{if(!e)return void t("");const a=new FileReader;a.onloadend=()=>{const e=a.result.split(",")[1];t(e)},a.onerror=()=>t(""),a.readAsDataURL(e)}),o)}catch(e){console.log("Lỗi khi xử lý blob URL:",e),t("")}},a.onerror=()=>{clearTimeout(o),t("")},a.src=e,console.log("This is img:"),console.log("img src:",a.src)}))}catch(w){return console.log("Lỗi khi xử lý blob URL:",w),""}}if("string"==typeof e){console.log("Vao den input string:");try{for(let y=0;y<c;y++)try{const k=new AbortController,b=setTimeout((()=>k.abort()),a),v=await fetch(e,{signal:k.signal});if(clearTimeout(b),!v.ok)throw new Error(`HTTP error ${v.status}`);const T=await v.blob();return await new Promise(((e,t)=>{const a=new FileReader;a.onloadend=()=>e(a.result.split(",")[1]),a.onerror=()=>t(new Error("Failed to read blob as base64")),a.readAsDataURL(T)}))}catch(E){if(y===c-1)return console.log("Hết lượt thử fetch:",E),"";await o(500)}}catch(S){return console.log("Lỗi khi fetch URL:",S),""}}return console.log("Đầu vào không được hỗ trợ:",e),""}catch(_){return console.log("Lỗi chung trong fetchImageToBase64:",_),""}}function n(e,t){return new Promise((a=>{const o=Date.now(),c=setInterval((()=>{for(const t of e){if(document.querySelector(t))return clearInterval(c),void a(!0)}Date.now()-o>=t&&(clearInterval(c),a(!1))}),500)}))}let i,r,l,s,u,h;async function f(){console.log("Run setup tiktok..."),i=await a(e.POWER_ON.key,e.POWER_ON.defaultValue),r=await a(e.API_KEY.key,e.API_KEY.defaultValue);const t=await a(e.TIKTOK.key,e.TIKTOK.defaultValue);l=t.delayClick,s=t.delaySwipe,u=t.loop,h=t.isActive,console.log("POWER_ON:",i),console.log("Da vao API_KEY:",r),console.log("Da vao IS_ACTIVE:",h)}console.log("Run tiktok...",window.location.href);let g=!1;async function d(){for(console.log("Day la captchaRotate");;){await o(500);var e,t="";for(let e=0;e<10&&null==(t=document.querySelector('img[data-testid="whirl-outer-img"]'));e++)await o(1e3);if(e=document.querySelector('img[data-testid="whirl-inner-img"]'),!t||!e)return;var a=null,c=null;for(let n=0;n<10&&(a=t.src,c=e.src,""===a||""===c);n++)await o(1e3);if(""===a||""===c){if(u){document.querySelector('a[class*="secsdk_captcha_refresh RefreshButton" i]').click();continue}return}const i={type:"TiktokRotateWebTask",imageUrls:[a,c]},r=await I(i);if(null===r||""===r){if(u){document.querySelector('a[class*="secsdk_captcha_refresh RefreshButton" i]').click();continue}return}const l=await q(r,30);if(!l){if(u){document.querySelector('a[class*="secsdk_captcha_refresh RefreshButton" i]').click();continue}return}const s=271-271*parseFloat(l.rotate);var n=document.querySelector("#secsdk-captcha-drag-wrapper");if(await T(n,s),u){if(await v("#secsdk-captcha-drag-wrapper",500,5e3)){console.log("Giải captcha thành công");break}console.log("Giải captcha thất bại")}}}async function m(){for(;;){await o(500);var e,t="";for(let e=0;e<10&&(null==(t=document.querySelector('[class*="captcha"]>[role="main"] [class*="cap-items-center "] img[class*="[210px]"]'))||R('[class*="captcha"]>[role="main"] [class*="cap-items-center "] img[class*="[210px]"]'));e++)await o(1e3);if(e=document.querySelector('[class*="captcha"]>[role="main"] [class*="cap-items-center "] img[class*="[128px]"]'),!t||!e)return;var a=null,n=null;for(let c=0;c<10&&(a=t.src,n=e.src,""===a||""===n);c++)await o(1e3);if(""===a||""===n){if(u){_();continue}return}var i=a.startsWith("blob:")?{type:"TiktokRotateWebTask",imageBase64s:[await c(a),await c(n)]}:{type:"TiktokRotateWebTask",imageUrls:[a,n]};const s=await I(i);if(null===s||""===s){if(u){_();continue}return}const h=await q(s,30);if(!h){if(u){_();continue}return}var r=document.querySelector('[class*="captcha"]>[role="main"] [class*="absolute"][draggable="true"]');let f=parseFloat(h.rotate);isNaN(f)&&(f=0);var l=parseInt(A(r),10);const g=l-l*f;if(await E(r,g),u){if(!await v('[class*="captcha"]>[role="main"] svg [d*="M24 4"]',500,5e3)){console.log("Giải captcha thành công");break}console.log("Giải captcha thất bại")}}}async function p(){for(console.log("captchaKeoTha");;){await o(500);var e=null;for(let t=0;t<10&&null==(e=document.querySelector("#captcha-verify-image"));t++)await o(1e3);if(!e)return;var t=null;for(let a=0;a<10&&null==(t=e.src);a++)await o(1e3);if(null===t){if(u){document.querySelector('a[class*="secsdk_captcha_refresh RefreshButton" i]').click();continue}return}const c={type:"TiktokSliderWebTask",imageUrl:t,widthView:e.width},n=await I(c);if(null===n||""===n){if(u){document.querySelector('a[class*="secsdk_captcha_refresh RefreshButton" i]').click();continue}return}const i=await q(n,30);if(!i){if(u){document.querySelector('a[class*="secsdk_captcha_refresh RefreshButton" i]').click();continue}return}let r=parseInt(i.end.x,10);var a=document.querySelector("#secsdk-captcha-drag-wrapper");if(await T(a,r),u){if(await v("#captcha-verify-image",500,5e3)){console.log("Giải captcha thành công");break}console.log("Giải captcha thất bại")}}}async function w(){for(console.log("captchaKeoTha_new");;){await o(500);var e=null;for(let t=0;t<10&&(null==(e=document.querySelector("#captcha-verify-image"))||R("#captcha-verify-image"));t++)await o(1e3);if(!e)return;var t=null;for(let a=0;a<10&&null==(t=e.src);a++)await o(1e3);if(null===t){if(u){_();continue}return}var a=t.startsWith("blob:")?{type:"TiktokSliderWebTask",imageBase64:await c(t),widthView:e.width}:{type:"TiktokSliderWebTask",imageUrl:t,widthView:e.width};const i=await I(a);if(null===i||""===i){if(u){_();continue}return}const r=await q(i,30);if(!r){if(u){_();continue}return}let l=.8*parseInt(r.end.x,10);var n=document.querySelector('[class*="captcha"]>[role="main"] [class*="absolute"][draggable="true"]');if(await E(n,l),u){if(!await v('[class*="captcha"]>[role="main"] svg [d*="M24 4"]',500,5e3)){console.log("Giải captcha thành công");break}console.log("Giải captcha thất bại")}}}async function y(){for(console.log("captcha3D");;){await o(500);var e=null;for(let t=0;t<10&&(null==(e=document.querySelector("#captcha-verify-image"))||R('[class*="captcha-verify-container"] img'));t++)await o(1e3);if(!e)return;var t=null;for(let a=0;a<10&&(await o(1e3),!(null!=(t=e.src)&&e.width>0&&e.height>0));a++);if(null===t){if(u){document.querySelector('a[class*="secsdk_captcha_refresh RefreshButton" i]').click();continue}return}const a={type:"Tiktok3DSelectObjectWebTask",imageUrl:t,widthView:e.width,heightView:e.height},c=await I(a);if(null===c||""===c){if(u){document.querySelector('a[class*="secsdk_captcha_refresh RefreshButton" i]').click();continue}return}const n=await q(c,30);if(!n){if(u){document.querySelector('a[class*="secsdk_captcha_refresh RefreshButton" i]').click();continue}return}let i=parseInt(n.pointA.x,10),r=parseInt(n.pointA.y,10),s=parseInt(n.pointB.x,10),h=parseInt(n.pointB.y,10);if(S(e,i,r),await o(l),S(e,s,h),await o(l),document.querySelector('div[class*="verify-captcha-submit-button SubmitButton" i]').click(),u){if(await v("#captcha-verify-image",500,5e3)){console.log("Giải captcha thành công");break}console.log("Giải captcha thất bại")}}}async function k(){for(console.log("captcha3D_new");;){await o(500);var e=null;for(let t=0;t<15&&(null==(e=document.querySelector('[class*="captcha-verify-container"] img'))||R('[class*="captcha-verify-container"] img'));t++)await o(1e3);if(!e)return;var t=null;for(let a=0;a<15&&(await o(1e3),!(null!=(t=e.src)&&e.width>0&&e.height>0));a++);if(null===t){if(u){_();continue}return}var a=t.startsWith("blob:")?{type:"Tiktok3DSelectObjectWebTask",imageBase64:await c(t),widthView:e.width,heightView:e.height}:{type:"Tiktok3DSelectObjectWebTask",imageUrl:t,widthView:e.width,heightView:e.height};const n=await I(a);if(null===n||""===n){if(u){_();continue}return}const i=await q(n,30);if(!i){if(u){_();continue}return}let r=parseInt(i.pointA.x,10),s=parseInt(i.pointA.y,10),h=parseInt(i.pointB.x,10),f=parseInt(i.pointB.y,10);if(S(e,r,s),await o(l),S(e,h,f),await o(l),document.querySelector('[class*="captcha-verify-container"] [class*="cap-relative"] [class="TUXButton-label"]').click(),u){if(!await v('[class*="captcha"]>[role="main"] svg [d*="M24 4"]',500,5e3)){console.log("Giải captcha thành công");break}console.log("Giải captcha thất bại")}}}function b(e){return!!document.querySelector(e)}async function v(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5e3;const o=Date.now();return async function c(){return!!document.querySelector(e)||!(Date.now()-o>a)&&(await new Promise((e=>setTimeout(e,t))),c())}()}function T(e,t){return new Promise((a=>{var o=new MouseEvent("mousedown",{bubbles:!0});e.dispatchEvent(o);var c=s,n=0;!function o(){n+=1;var i=new MouseEvent("mousemove",{bubbles:!0,clientX:n,clientY:0});if(e.dispatchEvent(i),n<t)setTimeout(o,c);else{var r=new MouseEvent("mouseup",{bubbles:!0});e.dispatchEvent(r),a()}}()}))}function E(e,t){return new Promise((a=>{var o=new DragEvent("dragstart",{bubbles:!0,clientX:0,clientY:8});e.dispatchEvent(o);var c=0,n=s;!function o(){c+=1;var i=new DragEvent("drag",{bubbles:!0,clientX:c,clientY:8});e.dispatchEvent(i),c<t?setTimeout(o,n):setTimeout((()=>{var t=new DragEvent("dragend",{bubbles:!0});e.dispatchEvent(t),a()}),1e3)}()}))}function S(e,t,a){var o=e.getBoundingClientRect(),c=o.left+t,n=o.top+a,i=new MouseEvent("click",{bubbles:!0,clientX:c,clientY:n});e.dispatchEvent(i)}function _(){for(var e=document.querySelectorAll('[class*="captcha-verify-container"] button'),t=0;t<e.length;t++){if(e[t].querySelector('[d*="M56"]')){e[t].click();break}}}function R(e){const t=document.querySelector(e);return t?"IMG"===t.tagName||"IFRAME"===t.tagName?!t.complete:!!t.classList.contains("loading"):(console.warn(`Phần tử với selector "${e}" không tồn tại.`),!1)}function A(e){if(!e)return console.warn("Không tìm thấy phần tử!"),null;const t=e.parentElement;if(!t)return console.warn("Phần tử không có cha hợp lệ!"),null;return t.clientWidth-e.clientWidth}async function I(e){const a=JSON.stringify({clientKey:r,task:e});try{const e=await t("TIKTOK","createTask",a);return e||(console.error("[tiktok] No taskId returned from createTask"),"")}catch(e){return console.error("[tiktok] Failed to create task:",e),""}}async function q(e,a){const o=JSON.stringify({clientKey:r,taskId:e});try{const e=await t("TIKTOK","getTaskResult",{data:o,timeWait:a});return e?"fail"===e.status?(console.error("[tiktok] API error:",e),null):e.solution?e.solution:(console.error("[tiktok] Invalid API response: missing solution"),null):(console.error("[tiktok] No result returned from getTaskResult"),null)}catch(e){return console.error("[tiktok] Failed to get task result:",e),null}}new MutationObserver((async(e,t)=>{await async function(e){if(console.log("Run handleElementMutation..."),await f(),i&&h&&r&&"YOUR_CLIEN_KEY"!==r)for(const t of e){if(console.log("Run for mutationsList"),console.log("Mutation type",t.type),"childList"!==t.type)continue;const e=document.querySelector('[role="dialog"][class*="captcha"]');if(console.log("isElementVisible",g),e&&!g){g=!0,await o(1500);try{if(!await n(['img[data-testid="whirl-outer-img" i]','img[class*="captcha_verify_img_slide" i]','div[class*="verify-captcha-submit-button SubmitButton" i]','[class*="captcha-verify-container"] [class="TUXButton-label"]','[class*="captcha"]>[role="main"] [class*="cap-items-center "] img','[class*="captcha"]>[role="main"] img[class*="cap-w-full cap-h-auto"]'],1e4)){console.log("Không thấy elementExists");continue}for(let e=0;e<30;e++){if(console.log("Vòng lặp: ",e),b('img[data-testid="whirl-outer-img" i]')){console.log("Tìm thấy captchaRotate"),await d();break}if(b('img[class*="captcha_verify_img_slide" i]')){console.log("Tìm thấy captchaKeoTha"),await p();break}if(b('div[class*="verify-captcha-submit-button SubmitButton" i]')){console.log("Tìm thấy captcha3D"),await y();break}if(b('[class*="captcha"]>[role="main"] [class="cap-flex cap-absolute "][style*="left: 0px;"]')&&2===document.querySelectorAll('[class*="captcha"]>[role="main"] [class*="cap-relative"] img').length){console.log("Tìm thấy captchaKeoTha_new"),await w();break}if(b('[class*="captcha-verify-container"] [class="TUXButton-label"]')&&"Confirm"===document.querySelector('[class*="captcha-verify-container"] [class="TUXButton-label"]').textContent||b('[class*="captcha"]>[role="main"] img[class*="cap-w-full cap-h-auto"]')){console.log("Tìm thấy captcha3D_new"),await k();break}if(b('[class*="captcha"]>[role="main"] [class*="cap-items-center "] img')&&document.querySelectorAll('[class*="captcha"]>[role="main"] [class*="cap-items-center "] img').length>=2){console.log("Tìm thấy captchaRotate_new"),await m();break}await o(1e3)}}catch(e){console.log("Lỗi:",e)}finally{g=!1}}}}(e)})).observe(document.body,{childList:!0,subtree:!0}),(async()=>{await f()})()})();