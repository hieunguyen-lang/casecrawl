(()=>{"use strict";const e={API_KEY:{key:"api_key",defaultValue:""},POWER_ON:{key:"power_on",defaultValue:!0},TIKTOK:{key:"tiktok",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},FUNCAPTCHA:{key:"funcaptcha",defaultValue:{delayClick:100,loop:!0,isActive:!0,maxImageCaptcha:1e4}},ZALO:{key:"zalo",defaultValue:{delayClick:100,loop:!0,isActive:!0}},SHOPEE:{key:"shopee",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},RECAPTCHAV2:{key:"reCaptchav2",defaultValue:{delayClick:500,loop:!0,isActive:!0,useToken:!1}},AMZN:{key:"amzn",defaultValue:{delayClick:100,loop:!0,isActive:!0}},GEETEST:{key:"geetest",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},GARENA:{key:"garena",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}}};async function t(e,t,o){const n="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{return await new Promise(((a,s)=>{n.sendMessage({source:e,type:t,data:o},(e=>{n.lastError?s(new Error(`Error sending message: ${n.lastError.message}`)):a(e)}))}))}catch(e){throw console.error(`[messageHelpers] Error in sending message: ${e.message}`),e}}const o=async(e,t)=>{const o="undefined"!=typeof browser?browser.storage.local:chrome.storage.local,n="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{const a=await o.get([e]);if(n.lastError)throw new Error(`Error retrieving ${e}: ${n.lastError.message}`);return null!=a[e]?a[e]:t}catch(t){throw console.error(`[storageHelpers] Error retrieving ${e}:`,t),t}};Promise.resolve();async function n(e){return new Promise((t=>setTimeout(t,e)))}function a(e,t){return new Promise((o=>{const n=Date.now(),a=setInterval((()=>{for(const t of e){if(document.querySelector(t))return clearInterval(a),void o(!0)}Date.now()-n>=t&&(clearInterval(a),o(!1))}),500)}))}function s(e,t){return new Promise((o=>{const n=document.querySelector(e);if(n)return o(n);const a=new MutationObserver(((t,n)=>{const a=document.querySelector(e);a&&(n.disconnect(),o(a))}));a.observe(document.body,{childList:!0,subtree:!0}),setTimeout((()=>{a.disconnect(),o(null)}),t)}))}let r,c,l,i,u,d;async function g(){r=await o(e.POWER_ON.key,e.POWER_ON.defaultValue),c=await o(e.API_KEY.key,e.API_KEY.defaultValue);const t=await o(e.GEETEST.key,e.GEETEST.defaultValue);l=t.delayClick,i=t.delaySwipe,u=t.loop,d=t.isActive}console.log("Run file Geetest:",window.location.href);let y=!1,f="";async function m(){console.log("abc")}async function w(){for(console.log("This is captchaKeoTha");;){await n(500);var e=null;for(let t=0;t<10&&null==(e=document.querySelector('[class*="geetest_captcha"] [class*="geetest_slide"] [class*="geetest_window"]'));t++)await n(1e3);if(!e)return;let o="";for(let t=0;t<10;t++){if(o=await E(e),o&&f!==o){f=o;break}await n(1e3)}if(!o)return;console.log("This is imgBase64>>>",o);const a={type:"GeetestSliderWebTask",imageBase64:o},r=await b(a);if(!r){if(u){document.querySelector('button[class*="geetest_refresh"]').click();continue}return}const c=await k(r,30);if(console.log("Day la result>>>",c),!c){if(u){document.querySelector('button[class*="geetest_refresh"]').click();continue}return}let l=parseInt(c.end.x,10);var t=document.querySelector('[class*="geetest_slide"] [class*="geetest_window"] [class*="geetest_slice"]');if(await p(t,l),u){if(await s('[class*="geetest_lock_success"]',5e3)){console.log("Giải captcha thành công");break}console.log("Giải captcha thất bại")}}}function h(e){return!!document.querySelector(e)}async function p(e,t){return new Promise((o=>{if(!e)return o();e.parentElement;const a=t,s=new DataTransfer,r=i;function c(t){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e.dispatchEvent(new MouseEvent(t,{bubbles:!0,cancelable:!0,...o})),e.dispatchEvent(new PointerEvent(t,{bubbles:!0,cancelable:!0,...o,pointerType:"mouse",isPrimary:!0}))}(async()=>{c("mouseenter"),c("mouseover"),await n(r),c("pointerdown",{clientX:0,clientY:0}),c("mousedown",{clientX:0,clientY:0}),e.dispatchEvent(new DragEvent("dragstart",{bubbles:!0,cancelable:!0,dataTransfer:s}));let l=0,i=0;for(;l+10<t;){const e=l/t;let o;o=e<.3?2*Math.random()+1:e<.7?6*Math.random()+2:2*Math.random()+.5,l+=o,i+=8*(Math.random()-.5);const s=Math.min(l,a),u=i;c("mousemove",{clientX:s,clientY:u}),c("pointermove",{clientX:s,clientY:u}),await n(r)}l=t;const u=i;c("mousemove",{clientX:l,clientY:u}),c("pointermove",{clientX:l,clientY:u}),await n(r),c("pointerup",{clientX:l,clientY:u}),c("mouseup",{clientX:l,clientY:u}),e.dispatchEvent(new DragEvent("dragend",{bubbles:!0,cancelable:!0,dataTransfer:s})),console.log("Vị trí backend >>>",t),console.log(`Vị trí cuối cùng của element: x = ${l}, y = ${u}`),o()})()}))}async function b(e){const o=JSON.stringify({clientKey:c,task:e});try{const e=await t("GEETEST","createTask",o);return e||(console.error("[geetest] No taskId returned from createTask"),"")}catch(e){return console.error("[geetest] Failed to create task:",e),""}}async function k(e,o){const n=JSON.stringify({clientKey:c,taskId:e});try{const e=await t("GEETEST","getTaskResult",{data:n,timeWait:o});return e?"fail"===e.status?(console.error("[geetest] API error:",e),null):e.solution?e.solution:(console.error("[geetest] Invalid API response: missing solution"),null):(console.error("[geetest] No result returned from getTaskResult"),null)}catch(e){return console.error("[geetest] Failed to get task result:",e),null}}function E(e){return new Promise((async(t,o)=>{if(!(e instanceof HTMLElement))return t("");const n=e.getBoundingClientRect(),a=Math.round(n.width),s=Math.round(n.height);if(a<=0||s<=0)return t("");const r=document.createElement("canvas");r.width=a,r.height=s;const c=r.getContext("2d"),l=e=>new Promise(((t,o)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>t(n),n.onerror=()=>o(new Error("Không tải được ảnh: "+e)),n.src=e}));try{const n=e.querySelector(".geetest_bg")||e.querySelector('[class*="geetest_bg"]'),i=getComputedStyle(n),u=i.backgroundImage.match(/url\(["']?(.*?)["']?\)/)?.[1];if(!u)return o(new Error("Không tìm được ảnh nền"));const d=await l(u);c.drawImage(d,0,0,a,s);const g=e.querySelector(".geetest_slice")||e.querySelector('[class*="geetest_slice"]'),y=g?.querySelector(".geetest_slice_bg")||g?.querySelector('[class*="geetest_slice_bg"]');if(g&&y){const e=getComputedStyle(g),t=getComputedStyle(y),o=t.backgroundImage.match(/url\(["']?(.*?)["']?\)/)?.[1],n=parseFloat(e.top)||0,a=parseFloat(e.left)||0,s=parseFloat(e.width)||0,r=parseFloat(e.height)||0;if(o&&s&&r){const e=await l(o);c.drawImage(e,a,n,s,r)}}t(r.toDataURL("image/png").split(",")[1])}catch(e){console.error("[captcha] Lỗi khi render Geetest:",e),o(e)}}))}(async()=>{await g();new MutationObserver((async(e,t)=>{await async function(e){if(await g(),r&&d&&c&&"YOUR_CLIEN_KEY"!==c){console.log("[geetest] handleElementMutation");for(const t of e)if("childList"===t.type){if(!document.querySelector('[class*="geetest_captcha"] [class*="geetest_window"]')||y)continue;if(!c)return;y=!0;try{if(await n(1500),!await a(['[class*="geetest_box"][style="display: block;"] [class*="geetest_container"] [class*="geetest_slide"]'],1e4))return;console.log("Tìm thấy elementExists");for(let e=0;e<20;e++){if(h(".abc")){await m();break}if(h('[class*="geetest_box"][style="display: block;"] [class*="geetest_container"] [class*="geetest_slide"]')){console.log("Tìm thấy captchaKeoTha"),await w();break}await n(1e3)}}finally{y=!1}}}}(e)})).observe(document.body,{childList:!0,subtree:!0});for(let e=0;e<100;e++){const e=document.querySelector('[class*="geetest_captcha"] [class*="geetest_btn_click"]');if(document.querySelector('[class*="geetest_box"][style="display: block;"] [class*="geetest_container"]')){console.log("slideElement đã xuất hiện, thoát vòng lặp");break}e&&!y&&(console.log("Day la click"),e.click()),await n(1500)}})()})();