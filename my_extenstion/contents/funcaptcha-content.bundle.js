(()=>{"use strict";const e={API_KEY:{key:"api_key",defaultValue:""},POWER_ON:{key:"power_on",defaultValue:!0},TIKTOK:{key:"tiktok",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},FUNCAPTCHA:{key:"funcaptcha",defaultValue:{delayClick:100,loop:!0,isActive:!0,maxImageCaptcha:1e4}},ZALO:{key:"zalo",defaultValue:{delayClick:100,loop:!0,isActive:!0}},SHOPEE:{key:"shopee",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},RECAPTCHAV2:{key:"reCaptchav2",defaultValue:{delayClick:500,loop:!0,isActive:!0,useToken:!1}},AMZN:{key:"amzn",defaultValue:{delayClick:100,loop:!0,isActive:!0}},GEETEST:{key:"geetest",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},GARENA:{key:"garena",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}}};async function t(e,t,o){const n="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{return await new Promise(((r,c)=>{n.sendMessage({source:e,type:t,data:o},(e=>{n.lastError?c(new Error(`Error sending message: ${n.lastError.message}`)):r(e)}))}))}catch(e){throw console.error(`[messageHelpers] Error in sending message: ${e.message}`),e}}const o=async(e,t)=>{const o="undefined"!=typeof browser?browser.storage.local:chrome.storage.local,n="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{const r=await o.get([e]);if(n.lastError)throw new Error(`Error retrieving ${e}: ${n.lastError.message}`);return null!=r[e]?r[e]:t}catch(t){throw console.error(`[storageHelpers] Error retrieving ${e}:`,t),t}};Promise.resolve();async function n(e){return new Promise((t=>setTimeout(t,e)))}function r(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",o=document.getElementById("captcha-message");o||(o=document.createElement("div"),o.id="captcha-message",o.style.position="fixed",o.style.top="5px",o.style.left="10px",o.style.zIndex="99999999",o.style.padding="3px 3px",o.style.borderRadius="3px",o.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.2)",o.style.fontSize="10px",o.style.fontWeight="600",o.style.fontFamily="Arial, sans-serif",o.style.textAlign="center",o.style.whiteSpace="nowrap",o.style.color="white",document.body.appendChild(o));const n={success:"linear-gradient(90deg, #6a11cb,rgb(191, 37, 252))",error:"linear-gradient(90deg, #ff416c, #ff4b2b)",warning:"linear-gradient(90deg, #ff9a44, #fc6076)",info:"linear-gradient(90deg, #17a2b8, #138496)"};o.innerText="[OMOcaptcha.com] "+e,o.style.background=n[t]||n.success,o.style.display="block"}async function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{timeout:5e3,maxRetries:3};try{const{timeout:o,maxRetries:r}=t,c={arkoselabs:"image/jpeg"};function a(e){for(const[t,o]of Object.entries(c))if(e.includes(t))return o;return"image/png"}if(e instanceof HTMLCanvasElement||e.tagName&&"CANVAS"===e.tagName.toUpperCase())try{if(0===e.width||0===e.height)return console.log("Canvas rỗng hoặc không có kích thước"),"";const i=e.getBoundingClientRect(),s=i.width,l=i.height,u=document.createElement("canvas");u.width=s,u.height=l;u.getContext("2d").drawImage(e,0,0,s,l);const d="image/png",h=u.toDataURL(d).split(",")[1];return h||(console.log("Không thể lấy base64 từ canvas"),"")}catch(g){return console.log("Lỗi khi chụp màn hình canvas:",g),""}if(e instanceof Element)try{const f=e.src;if(f&&f.startsWith("data:image/")){const m=f.split(",")[1];return m||(console.log("Base64 rỗng từ src của element"),"")}e=f||""}catch(b){return console.log("Lỗi khi xử lý element:",b),""}if("string"==typeof e&&e.startsWith("blob:")){console.log("Da vao blob");try{return await new Promise((t=>{const o=new Image;o.setAttribute("crossOrigin","anonymous");const n=setTimeout((()=>{t("")}),1e3);o.onload=function(){console.log("Vao trong onload"),clearTimeout(n);try{const o=document.createElement("canvas");o.width=this.naturalWidth,o.height=this.naturalHeight;o.getContext("2d").drawImage(this,0,0);const n=a(e);o.toBlob((e=>{if(!e)return void t("");const o=new FileReader;o.onloadend=()=>{const e=o.result.split(",")[1];t(e)},o.onerror=()=>t(""),o.readAsDataURL(e)}),n)}catch(e){console.log("Lỗi khi xử lý blob URL:",e),t("")}},o.onerror=()=>{clearTimeout(n),t("")},o.src=e,console.log("This is img:"),console.log("img src:",o.src)}))}catch(p){return console.log("Lỗi khi xử lý blob URL:",p),""}}if("string"==typeof e){console.log("Vao den input string:");try{for(let y=0;y<r;y++)try{const v=new AbortController,w=setTimeout((()=>v.abort()),o),k=await fetch(e,{signal:v.signal});if(clearTimeout(w),!k.ok)throw new Error(`HTTP error ${k.status}`);const E=await k.blob();return await new Promise(((e,t)=>{const o=new FileReader;o.onloadend=()=>e(o.result.split(",")[1]),o.onerror=()=>t(new Error("Failed to read blob as base64")),o.readAsDataURL(E)}))}catch(x){if(y===r-1)return console.log("Hết lượt thử fetch:",x),"";await n(500)}}catch(A){return console.log("Lỗi khi fetch URL:",A),""}}return console.log("Đầu vào không được hỗ trợ:",e),""}catch(S){return console.log("Lỗi chung trong fetchImageToBase64:",S),""}}let a,i,s,l,u,d;async function h(){a=await o(e.POWER_ON.key,e.POWER_ON.defaultValue),i=await o(e.API_KEY.key,e.API_KEY.defaultValue);const t=await o(e.FUNCAPTCHA.key,e.FUNCAPTCHA.defaultValue);s=t.delayClick,l=t.loop,u=t.isActive,d=t.maxImageCaptcha}let g=!1;console.log("This is Funcaptcha");async function f(){console.log("Đã vào captchaClickImage1");let e=E(".challenge-instructions-container");if(!e)return;e=e.trim(),s<1e3&&(s=1e3);let t="";for(let o=0;o<500;o++){if(o>0){if(await n(s),w(['div[class*="tile-game-fail box screen"]','div[class*="match-game-fail box screen"]']))return l&&(r("Restart button...","red"),document.querySelector('[class*="restart-button"]').click()),r("Failed to solve captcha","red"),void console.log("Giải captcha thất bại");if(w(['div[class*="error box screen"]']))return l&&document.querySelector('div[class*="error box screen"] button').click(),r("Failed to solve captcha","red"),void console.log("Giải captcha thất bại");if(w(['div[class*="victory box screen"]']))return console.log("Giải captcha thành công"),void r("Successfully solved captcha","green")}const a=await p(t);if(!a)continue;t=a;const i=await c(t);if(!i)return console.error("Failed to fetch image base64 for URL:",t),r("Failed to fetch image base64 for URL","red"),void(l&&document.querySelector('[class*="restart-button"]').click());const u=await y(i,e,30);if(null===u)return void(l&&(r("Restart button...","red"),document.querySelector('[class*="restart-button"]').click()));if("Server 500"===u.result){t="";continue}const d=u.result.index;document.querySelector('button[aria-label*="Image '+d+'"]').click()}}async function m(){console.log("Đã vào captchaClickImage2");let e=E("#game_children_text");if(e){e=e.trim(),e.endsWith(".")&&(e=e.slice(0,-1)),s<1e3&&(s=1e3);for(let t=0;t<500;t++){if(t>0){await n(s);const e=await v(['div[class*="error box screen"] button',"#wrong_children_button"],1);if(e)return l&&e.click(),console.log("Giải captcha thất bại"),void r("Failed to solve captcha","red");if(k('[id="victoryScreen"]'))return console.log("Giải captcha thành công"),void r("Successfully solved captcha","green")}const o=document.querySelector("#game_challengeItem_image");if(!o)continue;const a=await c(o,{timeout:5e3,maxRetries:3});if(!a)return void(l&&document.querySelector('a[aria-label="Start over with a different challenge" i]').click());const i=await y(a,e,20);if(null===i)return void(l&&document.querySelector('a[aria-label="Start over with a different challenge" i]').click());if("Server 500"===i.result)continue;const u=i.result.index;await v(['[aria-label*="Image '+u+'" i]'],1e3)&&document.querySelector('[aria-label*="Image '+u+'" i]').click()}}}async function b(){console.log("Da vao captchaClickButton"),console.log("Gia tri MAX_IMAGE_CAPTCHA",d);let e=E(".match-game .text");if(!e)return;console.log("Text captcha tren",e);const t=e.match(/\(.*\b(\d+)\)$/);if(t){const e=parseInt(t[1],10);if(console.log("So lon nhat trong dau ngoac:",e),e>d)return console.log(`So image lon hon ${d}, stop function`),void r(`Image > ${d}, stop function`,"red")}e=e.split("(")[0].trim(),console.log("Text captcha giua",e),e.endsWith(".")&&(e=e.slice(0,-1)),console.log("Text captcha cuoi cung",e);let o="";for(let t=0;t<500;t++){if(t>0){if(await n(s),w(['div[class*="tile-game-fail box screen"]','div[class*="match-game-fail box screen"]']))return l&&(r("Restart captcha","red"),document.querySelector('[class*="restart-button"]').click()),console.log("Giải captcha thất bại"),void r("Failed to solve captcha","red");if(w(['div[class*="error box screen"]']))return l&&document.querySelector('div[class*="error box screen"] button').click(),console.log("Giải captcha thất bại"),void r("Failed to solve captcha","red");if(w(['div[class*="victory box screen"]']))return console.log("Giải captcha thành công"),void r("Successfully solved captcha","green")}const a=await p(o);if(!a)continue;o=a;const i=await c(o);if(!i)return console.error("Failed to fetch image base64 for URL:",o),void(l&&document.querySelector('[class*="restart-button"]').click());const u=await y(i,e,30);if(null===u)return void(l&&document.querySelector('[class*="restart-button"]').click());if("Server 500"===u.result){o="";continue}let d=parseInt(u.result.index,10);if(d-=1,d>30)return l&&(r("Restart button...","red"),document.querySelector('[class*="restart-button"]').click()),console.log("Giải captcha thất bại"),void r("Failed to solve captcha","red");for(let e=0;e<d;e++)e>0&&await n(s),A(document.querySelector(".right-arrow"));x(document.querySelector('div[class*="match-game box screen"] button'))}}async function p(e){const t=document.querySelector("body").innerHTML.match(/blob:https:\/\/(.*?)arkoselabs(.*?)\.com\/[a-zA-Z0-9-]+/);return t?e===t[0]?(await n(500),null):t[0]:(await n(500),null)}async function y(e,o,n){r("Creating task...","green");const c=await async function(e,o){const n=JSON.stringify({clientKey:i,task:{type:"FuncaptchaImageTask",imageBase64:e,other:o}});try{const e=await t("FUNCAPTCHA","createTask",n);return e||(console.error("[funcaptcha] No taskId returned from createTask"),r("No taskId returned from createTask","red"),"")}catch(e){return console.error("[funcaptcha] Failed to create task:",e),""}}(e,o);if(!c)return console.warn("[funcaptcha] Failed to create task"),r("Failed to create task","red"),null;const a=await async function(e,o){const n=JSON.stringify({clientKey:i,taskId:e});try{const e=await t("FUNCAPTCHA","getTaskResult",{data:n,timeWait:o});return e?"fail"===e.status?(console.error("[funcaptcha] API error:",e),r(`API error: ${e}`,"red"),null):e.solution?e.solution:(console.error("[funcaptcha] Invalid API response: missing result or index"),r("Invalid API response: missing result or index","red"),null):(console.error("[funcaptcha] No result returned from getTaskResult"),r("No result returned from getTaskResult","red"),null)}catch(e){return console.error("[funcaptcha] Failed to get task result:",e),r(`Failed to get task result: ${e}`,"red"),null}}(c,n);return{result:a,taskId:c}}async function v(e,t){const o=Math.ceil(t/1e3);for(let t=0;t<o;t++){await new Promise((e=>setTimeout(e,1e3)));for(const t of e){const e=document.querySelector(t);if(e)return e}}return null}function w(e){for(const t of e){const e=document.querySelector(t);if(e)return e}return null}function k(e){return!!document.querySelector(e)}function E(e){const t=document.querySelector(e);return t?t.textContent.trim():null}function x(e){if(!e)return void console.error("Element không hợp lệ.");if(console.log("Vao ham simulateHumanMouseMovement"),!function(e){const t=e.getBoundingClientRect();return t.width>0&&t.height>0&&t.bottom>=0&&t.right>=0&&t.top<=(window.innerHeight||document.documentElement.clientHeight)&&t.left<=(window.innerWidth||document.documentElement.clientWidth)}(e))return void console.error("Element không hiển thị hoặc không có kích thước hợp lệ.");console.log("Da qua isElementVisible");let t=!1;function o(){t=!0}e.addEventListener("click",o);const n=e.getBoundingClientRect(),r=n.left+n.width/2,c=n.top+n.height/2,a=Math.random()*window.innerWidth/2,i=Math.random()*window.innerHeight/2,s=Math.floor(20*Math.random())+10;function l(){e.removeEventListener("click",o),t||(e.click(),console.log("Đã phải click trực tiếp!"))}!function t(o){if(o>=s){const t=new MouseEvent("mouseup",{bubbles:!0,clientX:r,clientY:c});e.dispatchEvent(t);const o=new MouseEvent("click",{bubbles:!0,clientX:r,clientY:c});return e.dispatchEvent(o),console.log("Da qua MouseEvent click>>>"),void setTimeout(l,60)}const n=(u=o/s,1-Math.pow(1-u,3));var u;const d=a+(r-a)*n,h=i+(c-i)*n,g=5*(Math.random()-.5),f=5*(Math.random()-.5),m=new MouseEvent("mousemove",{bubbles:!0,clientX:d+g,clientY:h+f});if(document.dispatchEvent(m),0===o){const t=new MouseEvent("mouseover",{bubbles:!0,clientX:d+g,clientY:h+f});e.dispatchEvent(t)}if(o===s-1){const t=new MouseEvent("mousedown",{bubbles:!0,clientX:r,clientY:c});e.dispatchEvent(t)}const b=30*Math.random()+20;setTimeout((()=>t(o+1)),b)}(0)}function A(e){const t=new MouseEvent("click",{bubbles:!0,clientX:e.getBoundingClientRect().left+e.offsetWidth/2,clientY:e.getBoundingClientRect().top+e.offsetHeight/2,button:0});e.dispatchEvent(t)}new class{constructor(e,t){this.selectors=e,this.callback=t,this.processedNodes=new Set,this.observer=new MutationObserver(this.handleMutation.bind(this)),this.startObserving()}startObserving(){this.observer.observe(document.body,{childList:!0,subtree:!0})}stopObserving(){this.observer.disconnect()}async handleMutation(e){if(a&&u)for(const t of e){const e=Array.from(t.addedNodes);for(const t of e)if(t.nodeType===Node.ELEMENT_NODE)for(const e of this.selectors)if(t.matches(e)&&!this.processedNodes.has(t))this.processedNodes.add(t),await this.callback(e,[t]);else{const o=Array.from(t.querySelectorAll(e));for(const t of o)this.processedNodes.has(t)||(this.processedNodes.add(t),await this.callback(e,o))}}}}(['button[aria-describedby="descriptionVerify"]','p[aria-label*="Working, please wait" i]','button[data-theme="home.verifyButton"]',".error .button","#wrongTimeout_children_button",'button[id="home_children_button"]'],(async(e,t)=>{if(await h(),!g&&a&&u&&i&&"YOUR_CLIEN_KEY"!==i){console.log("Vào đến DOMObserver");try{g=!0,await n(1e3);const e=await v(['div[class*="error box screen"] button',"#wrong_children_button"],1e3);if(e)return l&&e.click(),void console.log("Giải captcha thất bại");for(let e=0;e<10;e++){const e=await v(['button[data-theme="home.verifyButton"]','button[id="home_children_button"]','button[aria-describedby="descriptionVerify"]'],1e3);if(e?(console.log("[funcaptcha] Click verifyButton"),e.click()):console.log("[funcaptcha] không tìm thấy verifyButton"),k(".challenge-instructions-container"))await f();else if(k(".match-game .text"))await b();else{if(!k("#game_children_text")){console.log("[funcaptcha] Không tìm thấy captcha");continue}await m()}console.log("[funcaptcha] chay xong findElement");break}}catch(e){console.error("Đã bị lỗi",e)}finally{g=!1}}})),(async()=>{await h()})()})();